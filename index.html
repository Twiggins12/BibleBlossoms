<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Bible Blossoms - Topical Reference</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 30px; max-width: 700px; margin: auto; }
    select, button { padding: 8px; margin: 5px 0; width: 100%; }
    #verseText { margin-top: 20px; white-space: pre-wrap; font-size: 1.1em; }
    h1 { text-align: center; }
  </style>
</head>
<body>

<h1>Bible Blossoms - Topical Reference</h1>

<select id="mainTopic">
  <option value="">Select Main Topic</option>
</select>

<select id="subheading">
  <option value="">Select Subheading</option>
</select>

<select id="book">
  <option value="">Select Book</option>
</select>

<select id="chapter">
  <option value="">Select Chapter</option>
</select>

<select id="verse">
  <option value="">Select Verse</option>
</select>

<button onclick="getVerse()">Get Verse</button>

<div id="verseText"></div>

<script>
  const mainTopicSelect = document.getElementById("mainTopic");
  const subheadingSelect = document.getElementById("subheading");
  const bookSelect = document.getElementById("book");
  const chapterSelect = document.getElementById("chapter");
  const verseSelect = document.getElementById("verse");
  const verseTextDiv = document.getElementById("verseText");

  let data = {}; // structured data from CSV

  // Replace with your published Master CSV link
  const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRfO-EOoUaTX55fOvNTUEHg1yG8kszdIGiikQYe1JdHyD1hQ5iNs3VL-7leImeg2JUrwoKHH0ZHIqgj/pub?gid=0&single=true&output=csv";

  // Fetch CSV and build structured data
  fetch(csvUrl)
    .then(res => res.text())
    .then(csvText => {
      const rows = csvText.split("\n").slice(1); // skip header
      rows.forEach(row => {
        const [main, sub, book, chapter, verse] = row.split(",");
        if(!main || !sub || !book || !chapter || !verse) return;

        if(!data[main]) data[main] = {};
        if(!data[main][sub]) data[main][sub] = {};
        if(!data[main][sub][book]) data[main][sub][book] = {};
        if(!data[main][sub][book][chapter]) data[main][sub][book][chapter] = [];
        data[main][sub][book][chapter].push(verse);
      });

      // Populate Main Topics dropdown after CSV loads
      Object.keys(data).forEach(topic => {
        const option = document.createElement("option");
        option.value = topic;
        option.text = topic;
        mainTopicSelect.add(option);
      });
    })
    .catch(err => console.error("Error loading CSV:", err));

  // Dropdown population events
  mainTopicSelect.addEventListener("change", () => {
    subheadingSelect.innerHTML = '<option value="">Select Subheading</option>';
    bookSelect.innerHTML = '<option value="">Select Book</option>';
    chapterSelect.innerHTML = '<option value="">Select Chapter</option>';
    verseSelect.innerHTML = '<option value="">Select Verse</option>';
    const subheadings = data[mainTopicSelect.value];
    if(subheadings){
      Object.keys(subheadings).forEach(sh => {
        const option = document.createElement("option");
        option.value = sh;
        option.text = sh;
        subheadingSelect.add(option);
      });
    }
  });

  subheadingSelect.addEventListener("change", () => {
    bookSelect.innerHTML = '<option value="">Select Book</option>';
    chapterSelect.innerHTML = '<option value="">Select Chapter</option>';
    verseSelect.innerHTML = '<option value="">Select Verse</option>';
    const books = data[mainTopicSelect.value][subheadingSelect.value];
    if(books){
      Object.keys(books).forEach(book => {
        const option = document.createElement("option");
        option.value = book;
        option.text = book;
        bookSelect.add(option);
      });
    }
  });

  bookSelect.addEventListener("change", () => {
    chapterSelect.innerHTML = '<option value="">Select Chapter</option>';
    verseSelect.innerHTML = '<option value="">Select Verse</option>';
    const chapters = data[mainTopicSelect.value][subheadingSelect.value][bookSelect.value];
    if(chapters){
      Object.keys(chapters).forEach(ch => {
        const option = document.createElement("option");
        option.value = ch;
        option.text = ch;
        chapterSelect.add(option);
      });
    }
  });

  chapterSelect.addEventListener("change", () => {
    verseSelect.innerHTML = '<option value="">Select Verse</option>';
    const verses = data[mainTopicSelect.value][subheadingSelect.value][bookSelect.value][chapterSelect.value];
    if(verses){
      verses.forEach(v => {
        const option = document.createElement("option");
        option.value = v;
        option.text = v;
        verseSelect.add(option);
      });
    }
  });

  // Fetch and display verse text from Bible API
  function getVerse(){
    const book = bookSelect.value;
    const chapter = chapterSelect.value;
    const verse = verseSelect.value;
    if(!book || !chapter || !verse){
      alert("Please select all dropdowns.");
      return;
    }
    fetch(`https://bible-api.com/${book} ${chapter}:${verse}`)
      .then(res => res.json())
      .then(data => {
        verseTextDiv.innerText = data.text;
      })
      .catch(()=> verseTextDiv.innerText = "Error fetching verse.");
  }
</script>

</body>
</html>
